(function(){var f,h,j={},r=function(a){return a._typeId=="670a1076-712b-4edd-9b70-64b152fe1cd9"},m=j.CanceledError=function(){};m.prototype={isTypeOf:r,_typeId:"670a1076-712b-4edd-9b70-64b152fe1cd9",message:"The task has been cancelled."};var s=j.AggregateError=function(a){this.children=[];if(a)for(var b=0;b<a.length;b++)this.children.push(a[b])};s.prototype={_typeId:"4a73efb8-c2e2-4305-a05c-72385288650a",message:"This is an error contains sub-errors, please check the 'children' collection for more details.",
isTypeOf:function(a){return a._typeId=="4a73efb8-c2e2-4305-a05c-72385288650a"}};(j.CancellationToken=function(){}).prototype={register:function(a){this.isCancellationRequested&&a();if(!this._handlers)this._handlers=[];this._handlers.push(a)},unregister:function(a){this._handlers&&(a=this._handlers.indexOf(a),a>=0&&this._handlers.splice(a,1))},cancel:function(){if(!this.isCancellationRequested){this.isCancellationRequested=!0;var a=this._handlers;delete this._handlers;for(var b=0;b<a.length;b++)try{a[b]()}catch(c){f.logger.warn("[WARNING] Cancellation handler threw an error: "+
c)}}},throwIfCancellationRequested:function(){if(this.isCancellationRequested)throw new m;}};var i=j.Task=function(a){this._delegate=a;this._listeners={};this.status="ready"};i.prototype={start:function(){if(this.status!="ready")throw Error('Task can only be started in "ready" status.');this.status="running";this._delegate(this);return this},complete:function(a,b){if(this.status!="running")throw Error('The "complete" method can only be called in "running" status.');var c=this._listeners;delete this._listeners;
if(a=="success")this.result=b,this.status="succeeded",this._notify("success",c.success);else if(a=="failure")this.error=b,this.status=r(b)?"canceled":"faulted",this._notify("failure",c.failure);else throw Error("Unsupported type: "+a);this._notify("complete",c.complete);this.error&&!c.failure&&!c.complete&&f.logger.warn("[WARNING] An unhandled error occurred: "+this.error)},_notify:function(a,b){if(b)for(var c=0;c<b.length;c++)b[c].call(this)},addEventListener:function(a,b){if(!this._listeners)return this;
this._listeners[a]||(this._listeners[a]=[]);this._listeners[a].push(b);return this},removeEventListener:function(a,b){if(!this._listeners)return this;var c=this._listeners[a];if(!c)return this;var d=c.indexOf(b);d>=0&&c.splice(d,1);return this},then:function(a){var b=this;return i.create(function(c){var d=function(){this.error?c.complete("failure",this.error):c.complete("success",this.result)},e=function(){if(this.error)return c.complete("failure",this.error);var b;try{b=a(this.result)}catch(g){return c.complete("failure",
g)}b.status=="ready"&&b.start();b.status=="running"?b.addEventListener("complete",d):d.call(b)};b.status=="ready"&&b.start();b.status=="running"?b.addEventListener("complete",e):e.call(b)})}};var n=i.isTask=function(a){return a&&typeof a.start==="function"&&typeof a.addEventListener==="function"&&typeof a.removeEventListener==="function"&&typeof a.complete==="function"},t=i.create=function(a){return new i(a)},w=i.whenAll=function(){var a;if(arguments.length==1){var b=arguments[0];a=n(b)?[b]:b}else{a=
Array(arguments.length);for(b=0;b<arguments.length;b++)a[b]=arguments[b]}return t(function(b){var d=function(){var d=h.isArray(a)?Array(a.length):{},g=[];h.each(a,function(a,b){b.error?g.push(b.error):d[a]=b.result});g.length>0?b.complete("failure",new s(g)):b.complete("success",d)},e=0;h.each(a,function(b,c){c&&(n(c)||(a[b]=c=w(c)),c.status==="ready"&&c.start(),c.status==="running"&&(e++,c.addEventListener("complete",function(){--e==0&&d()})))});e==0&&d()})};i.whenAny=function(){var a={},b=!0;if(arguments.length==
1){var c=arguments[0];n(c)?a[0]=c:(b=h.isArray(c),h.each(c,function(b,c){n(c)&&(a[b]=c)}))}else for(c=0;c<arguments.length;c++){var d=arguments[c];n(d)&&(a[c]=d)}var e=b?function(a){return parseInt(a,10)}:function(a){return a};return t(function(b){if(h.isEmpty(a))return b.complete("failure","There's no valid input tasks.");h.each(a,function(a,b){b.status=="ready"&&b.start()});var c=h.each(a,function(a,b){if(b.status!=="running")return{key:e(a),task:b}});if(c)return b.complete("success",c);var d=function(){var c=
this;h.each(a,function(a,g){g==c?b.complete("success",{key:e(a),task:g}):g.removeEventListener("complete",d)})};h.each(a,function(a){a.addEventListener("complete",d)})})};j.sleep=function(a,b){return i.create(function(c){b&&b.isCancellationRequested&&c.complete("failure",new m);var d,e;b&&(e=function(){clearTimeout(d);c.complete("failure",new m)});d=setTimeout(function(){b&&b.unregister(e);c.complete("success")},a);b&&b.register(e)})};j.onEvent=function(a,b,c){return i.create(function(d){c&&c.isCancellationRequested&&
d.complete("failure",new m);var e=function(){a.removeEventListener?a.removeEventListener(b,k):a.removeListener?a.removeListener(b,k):a.detachEvent(b,k)},k,g;c&&(g=function(){e();d.complete("failure",new m)});k=function(a){c&&c.unregister(g);e();d.complete("success",a)};a.addEventListener?a.addEventListener(b,k):a.addListener?a.addListener(b,k):a.attachEvent(b,k);c&&c.register(g)})};var o=j.AsyncBuilder=function(){};o.prototype={Start:function(a,b){return i.create(function(c){b.next(a,function(a,b){if(a==
"normal"||a=="return")c.complete("success",b);else if(a=="throw")c.complete("failure",b);else throw Error("Unsupported type: "+a);})})},Bind:function(a,b){return{next:function(c,d){var e=function(){if(this.error)d("throw",this.error);else{var a;try{a=b.call(c,this.result)}catch(e){d("throw",e);return}a.next(c,d)}};a.status=="ready"?(a.addEventListener("complete",e),a.start()):a.status=="running"?a.addEventListener("complete",e):e(a)}}}};var l=j.Binding={},u=function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a[d]);
for(;c.length<b;)c.push(void 0);return c},v=function(a){if(a.length<=1)return null;for(var b=[],c=1;c<a.length;c++)b.push(a[c]);return b};l.fromStandard=function(a){var b=v(arguments);return function(){var c=this,d=u(arguments,a.length-1);return i.create(function(e){d.push(function(a,c){if(a)e.complete("failure",a);else if(b){for(var d={},f=0;f<b.length;f++)d[b[f]]=arguments[f+1];return e.complete("success",d)}else e.complete("success",c)});a.apply(c,d)})}};l.fromCallback=function(a){var b=v(arguments);
return function(){var c=this,d=u(arguments,a.length-1);return i.create(function(e){d.push(function(a){if(b){for(var c={},d=0;d<b.length;d++)c[b[d]]=arguments[d];e.complete("success",c)}else e.complete("success",a)});a.apply(c,d)})}};var p=!!(typeof require==="function"&&typeof module!=="undefined"&&module.exports);l=!!(typeof require==="function"&&typeof define==="function"&&define.amd);var q=function(){f.define({name:"async",version:"0.7.0",exports:p&&module.exports,require:p&&require,autoloads:["builderbase"],
dependencies:{builderbase:"~0.6.5"},init:function(){h=f._;h.each(f.BuilderBase.prototype,function(a,b){o.prototype[a]=b});f.Async=j;f.binders.async="$await";f.builders.async=new o}})};if(p){try{f=require("./wind")}catch(x){f=require("wind")}q()}else if(l)require(["wind"],function(a){f=a;q()});else{l=Function("return this")();if(!l.Wind)throw Error('Missing the root object, please load "wind" component first.');f=l.Wind;q()}})();
