<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <title>Cards</title>
    
    <script language="javascript" type="text/javascript" src="../../src/narcissus.js"></script>
    <script language="javascript" type="text/javascript" src="../../src/jscex.js"></script>
    <script language="javascript" type="text/javascript" src="../../src/jscex.async.js"></script>
    <script language="javascript" type="text/javascript" src="../../src/jscex.async.xhr.js"></script>

    <script>

    var moveAsync = eval(Jscex.compile("$async", function(e, startPos, endPos, duration) {
        for (var t = 0; t < duration; t += 50) {
            e.style.left = startPos.x + (endPos.x - startPos.x) * t / duration;
            e.style.top = startPos.y + (endPos.y - startPos.y) * t / duration;
            $await(Jscex.Async.sleep(50));
        }

        e.style.left = endPos.x;
        e.style.top = endPos.y;
    }));

    var createCard = function() {
        var card = document.createElement("div");
        card.style.position = "absolute";
        card.style.border = "solid 1px black";
        card.style.backgroundImage = "url(card.png)";
        card.style.width = 57;
        card.style.height = 80;

        document.body.appendChild(card);
        return card;
    }

    // Pseudocode, cannot work
    var deal = function() {
        var req = new XMLHttpRequest();
        req.open("GET", "/tool.php?s=2&m=5");
        var text = req.receive(); // cannot receive;
        var count = parseInt(text, 10); 
        
        var fakeCard = createCard();
        fakeCard.style.left = 10;
        fakeCard.style.top = 10;

        for (var i = 0; i < count; i++) {
            var topCard = createCard();
            move(
                topCard,
                {x: 10, y: 10},
                {x: 160 + 80 * i, y: 10},
                500);

            if (i == count - 1) {
                document.body.removeChild(fakeCard);
            }

            var bottomCard = createCard();
            move(
                bottomCard,
                {x: 10, y: 10},
                {x: 160 + 80 * i, y: 160},
                500);
        }
    }
    
    var dealAsync = eval(Jscex.compile("$async", function() {
        var req = new XMLHttpRequest();
        req.open("GET", "/tool.php?s=2&m=5");
        var text = $await(req.receiveAsync());
        var count = parseInt(text, 10);
        
        var fakeCard = createCard();
        fakeCard.style.left = 10;
        fakeCard.style.top = 10;

        for (var i = 0; i < count; i++) {
            var topCard = createCard();
            $await(moveAsync(
                topCard,
                {x: 10, y: 10},
                {x: 160 + 80 * i, y: 10},
                500));

            if (i == count - 1) {
                document.body.removeChild(fakeCard);
            }

            var bottomCard = createCard();
            $await(moveAsync(
                bottomCard,
                {x: 10, y: 10},
                {x: 160 + 80 * i, y: 160},
                500));
        }
    }));

</script>
</head>
<body>
    <script type="text/javascript">
        Jscex.Async.start(dealAsync());
    </script>
</body>
</html>

